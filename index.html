<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <meta charset="utf-8"/>
    <title>Age of Empires II Tech Tree</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="container">
    <div id="navigation">
        <select id="civselect" onchange="loadCiv()">
            <option>Aztecs</option>
            <option>Berbers</option>
            <option>Britons</option>
            <option>Bulgarians</option>
            <option>Burmese</option>
            <option>Byzantines</option>
            <option>Celts</option>
            <option>Chinese</option>
            <option>Cumans</option>
            <option>Ethiopians</option>
            <option>Franks</option>
            <option>Goths</option>
            <option>Huns</option>
            <option>Incas</option>
            <option>Indians</option>
            <option>Italians</option>
            <option>Japanese</option>
            <option>Khmer</option>
            <option>Koreans</option>
            <option>Lithuanians</option>
            <option>Magyars</option>
            <option>Malay</option>
            <option>Malians</option>
            <option>Mayans</option>
            <option>Mongols</option>
            <option>Persians</option>
            <option>Portuguese</option>
            <option>Saracens</option>
            <option>Slavs</option>
            <option>Spanish</option>
            <option>Tatars</option>
            <option>Teutons</option>
            <option>Turks</option>
            <option>Vietnamese</option>
            <option>Vikings</option>
        </select>
        <div id="info">Version: Age of Empires II DE Update 34699  |
            <a href="https://github.com/HSZemi/aoe2techtree" target="_blank">GitHub</a>
        </div>
    </div>
    <div id="wrapper">
        <div id="metainfo">
            <div style="
            position: absolute;
            left: calc(var(--meta-info-width) + 2 * var(--meta-info-padding) + var(--border-size));
            z-index: 2;
            background-color: #e7c28e;
            padding: 5px;
            border: 2px solid #4d3616;
            border-left: none;
        "><button id="minimize_meta" style="background-color: transparent;
    border: none;
    padding: 2px;">&lt;</button>
          
            </div>
            <div id="civinfo">
                <div id="civtitle">
                    <h2 id="civname">Loading…</h2>
                    <img id="civlogo" height=52 width=52 data-transparent="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
                </div>
                <hr>
                <p id="civtext"></p>
            </div>
            <div id="thanks">
                <a href="https://github.com/SiegeEngineers/aoe2techtree" target="_blank">Made by hszemi</a>,<br>
                with huge thanks to Jineapple, TriRem, pip, and NkoDragaš
                <!-- <br> Descriptions taken from the
                <a href="https://www.voobly.com/gamemods/mod/650/Max-Extended-Help-AK" target="_blank">Max-Extended-Help-WK
                    mod</a> -->
                <br> Item Metadata (cost, HP etc.) taken from
                <a href="https://github.com/HSZemi/aoe2dat" target="_blank">aoe2dat</a>
            </div>
        </div>
        <div id="techtree">
            <div id="helptext">
              <div id="helptext__content"></div>
              <div id="helptext__x_ref"></div>
            </div>
        </div>
    </div>
</div>
<script src="js/svg.min.js"></script>
<script src="js/techtree.js"></script>
<script src="js/civ_config.js"></script>
<script type="text/javascript">
    var tree = getDefaultTree();
    var data = {};
    let connections = getConnections();
    let connectionpoints = getConnectionPoints(tree);

    // setup the minimize button
    let minimizeMetaButton = document.getElementById('minimize_meta');
    minimizeMetaButton.addEventListener('click', toggleMinimuzeMeta);

    function toggleMinimuzeMeta() {
      document.getElementById('metainfo').style.width = "0px"
      document.getElementById('civinfo').style.display = "none"
      document.getElementById('thanks').style.display = "none"
    }


    loadJson(function (response) {
        data = JSON.parse(response);

        let hash = window.location.hash.substr(1);
        if (hash in data.civs) {
            document.getElementById('civselect').value = hash;
        }

        var draw = SVG('techtree').size(tree.width, tree.height)

        draw.rect(tree.width, tree.height).attr({fill: '#e7c28e'}).click(function () {
            hideHelp();
        });
        draw.rect(tree.width, 6).attr({fill: '#4d3617'}).click(function () {
            hideHelp();
        }).y(tree.height / 4);
        draw.rect(tree.width, 6).attr({fill: '#4d3617'}).click(function () {
            hideHelp();
        }).y(tree.height / 4 * 2);
        draw.rect(tree.width, 6).attr({fill: '#4d3617'}).click(function () {
            hideHelp();
        }).y(tree.height / 4 * 3);

        for (let connection of connections) {
            let from = connectionpoints.get(connection[0]);
            let to = connectionpoints.get(connection[1]);
            let intermediate_height = from.y + (tree.element_height * 2 / 3);
            draw.polyline([from.x, from.y, from.x, intermediate_height, to.x, intermediate_height, to.x, to.y])
                .fill('none').stroke({width: 2})
                .click(function () {
                    hideHelp();
                });
        }

        for (let lane of tree.lanes) {
            for (let r of Object.keys(lane.rows)) {
                let row = lane.rows[r];
                for (let caret of row) {
                    var rect = draw.rect(caret.width, caret.height).attr({
                        fill: caret.type.colour,
                        id: caret.id
                    }).move(caret.x, caret.y);
                    let name = formatName(caret.name);
                    var text = draw.text(name)
                        .font({family: 'Helvetica', size: 8})
                        .attr({fill: '#fff', 'text-anchor': 'middle', id: caret.id + '_text'})
                        .move(caret.x + caret.width / 2, caret.y + caret.height / 1.5);
                    var image_placeholder = draw.rect(caret.width * 0.6, caret.height * 0.6)
                        .attr({fill: 'rgba(0,0,0,0.5)', id: caret.id + '_imgph'})
                        .move(caret.x + caret.width * 0.2, caret.y);
                    let prefix = 'img/';
                    var image = draw.image(prefix + imagePrefix(caret.id) + '.png', caret.width * 0.6, caret.height * 0.6)
                        .attr({id: caret.id + '_img'})
                        .move(caret.x + caret.width * 0.2, caret.y);
                    var cross = draw.polygon([1, 0, 3, 2, 5, 0, 6, 1, 4, 3, 6, 5, 5, 6, 3, 4, 1, 6, 0, 5, 2, 3, 0, 1])
                        .attr({fill: 'rgba(255,0,0,0.5)', id: caret.id + '_x'})
                        .addClass('cross')
                        .size(caret.width * 0.6, caret.height * 0.6)
                        .move(caret.x + caret.width * 0.2, caret.y);
                    var overlaytrigger = draw.rect(caret.width, caret.height)
                        .attr({fill: 'rgba(0,0,0,0)', id: caret.id + '_overlay'})
                        .move(caret.x, caret.y)
                        .data({'type': caret.type.type, 'caret': caret, 'name': caret.name, 'id': caret.id})
                        .click(function () {
                            displayHelp(caret.id + '_overlay');
                        });

                }
            }
        }

        // load the civs
        loadCiv();
        // Make the xref badges
        let badges = createXRefBadges();
        document.getElementById('helptext__x_ref').appendChild(badges);
    });

    function imagePrefix(name) {
        return name
            .replace("building_", "Buildings/")
            .replace("unit_", "Units/")
            .replace("tech_", "Techs/");
    }

    function loadCiv() {
        var selectedCiv = document.getElementById('civselect').value;
        civ(selectedCiv, tree);
        document.getElementById('civname').innerText = selectedCiv;
        if (selectedCiv in data.civs) {
            document.getElementById('civtext').innerHTML = data.key_value[data.civs[selectedCiv]];
            document.getElementById('civlogo').src = `./img/Civs/${selectedCiv.toLowerCase()}.png`;
            window.location.hash = selectedCiv;
        } else {
            document.getElementById('civtext').innerHTML = "";
            document.getElementById('civlogo').src = document.getElementById('civlogo').dataset.transparent;
        }
        hideHelp();
    }

    function loadJson(callback) {

        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', 'data/data.json', true);
        // xobj.open('GET', 'data/civs_breakdown.json', true);
        xobj.onreadystatechange = function () {
            if (xobj.readyState === 4 && xobj.status === 200) {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }

    function displayHelp(overlayId) {
        let helptext = document.getElementById("helptext");
        let helptextContent = document.getElementById("helptext__content");
        let helptextXRef = document.getElementById("helptext__x_ref");
        let overlay = SVG.get(overlayId);
        let name = overlay.data('name');
        let id = overlay.data('id');
        let caret = overlay.data('caret');
        let type = overlay.data('type');
        let content = getHelpText(name, id, type);
        helptextContent.innerHTML = content;

        badgeXRef(name, type);

        helptext.style.display = "block";

        let top = caret.y + caret.height;
        if (top + helptext.offsetHeight > tree.height) {
            top = top - helptext.offsetHeight - caret.height;
        }
        helptext.style.top = top + "px";

        // let helpbox = helptext.getBoundingClientRect();

        let destX = caret.x - helptext.offsetWidth;

        // helptext.style.left = Math.max(0, (caret.x - helptext.offsetWidth)) + "px";
        let helpbox = helptext.getBoundingClientRect();
        // check the scroll left
        let tt = document.getElementById('techtree');
        if (destX <= 0 || destX - tt.scrollLeft <= 0) {
            
            destX = caret.x + caret.width;
        }
        helptext.style.left = destX + 'px';
        console.log(caret.width)
        console.log(caret.x, caret.y, caret.width, helptext.style.width, helptext.offsetHeight, helptext.style.left, helptext.style.top)
    }

    function hideHelp() {
        helptext.style.display = "none";
    }

    function getHelpText(name, id, type) {
        let entitytype = 'buildings';
        if (type === "UNIT" || type === "UNIQUEUNIT") {
            entitytype = 'units';
        }
        if (type === "TECHNOLOGY") {
            entitytype = 'techs';
        }
        let text = data.key_value[data.name_key[entitytype][name]];
        if (text === undefined) {
            return "?";
        }
        let meta = data.meta[entitytype][name];
        if (meta !== undefined) {
            text = text.replace(/‹cost›/, "Cost: " + cost(meta.Cost));
            text = text.replace(/‹hp›/, "HP: " + meta.HP);
            text = text.replace(/‹attack›/, "Attack: " + meta.Attack);
            text = text.replace(/‹(A|a)rmor›/, "Armor: " + meta.MeleeArmor);
            text = text.replace(/‹(P|p)iercearmor›/, "Piercearmor: " + meta.PierceArmor);
            text = text.replace(/‹garrison›/, "Garrison: " + meta.GarrisonCapacity);
            text = text.replace(/‹range›/, "Range: " + meta.Range);
        } else {
            console.log("No metadata found for " + name);
        }
        return text;

    }

    /**
     * Create the Cross-Reference badges. This is done at load time in order to avoid re-making the
     * badges at runtime per-click on a new unit.
     * 
     * @return A container with buttons + images for each civ to be used in cross referencing.
     */
    function createXRefBadges() {
        let xRefLinks = document.createElement('div');
        xRefLinks.style.maxWidth = "calc(30px * 7)";
        xRefLinks.style.margin = "auto";
        xRefLinks.style.paddingTop = "0.2rem";
        for (let civ of Object.keys(data.civs)) {
            let xRefLink = document.createElement('button');
            xRefLink.addEventListener('click', function() {

              document.getElementById('civselect').value=civ;
              loadCiv();
            });
            xRefLink.style.backgroundColor = "transparent";
            xRefLink.style.border = "none";
            xRefLink.style.padding = 0;

            // Add a badge for this civ if this element isn't disabled, or if it is a unique unit and not enabled.
            let xRefImage = document.createElement('img');

            xRefImage.src = `./img/Civs/${civ}.png`;
            // xRefImage.style.width = "30px";
            // xRefImage.style.height = "30px";
            xRefImage.title = `${civ}`;
            xRefImage.id = `xRef__badge__${civ}`;
            xRefLink.appendChild(xRefImage);
            xRefLinks.appendChild(xRefLink);
        }
        return xRefLinks;
    }

    /** 
     * Set on/off of all cross reference badges.
     * 
     * @param {string} name The name of the entity being cross-reference. 
     * @param {string} type The type of the entity being cross-reference.
     */
    function badgeXRef(name, type) {
        let entitytype = 'buildings';
        if (type === "UNIT" || type === "UNIQUEUNIT") {
            entitytype = 'units';
        }
        if (type === "TECHNOLOGY") {
            entitytype = 'techs';
        }

        for (let civ of Object.keys(data.civs)) {
          let xRefImage = document.getElementById(`xRef__badge__${civ}`);
          let found = true;
          // Get all civs
         
          // Make sure this civ exists
          if (civsConfig[`${civ}`]) {
            // Fast-Fail horses if civ disablesHorses
            if (civsConfig[`${civ}`]['disableHorses']
                && horseDisabled.includes(name)) {
                  found = false;
            }
            if (type === "UNIT") {
                // Make sure this unit isn't disabled for this civ
                // if not enabled and default is disabled -> bad
                if (defaultDisabled.includes(name) && 
                    (!civsConfig[`${civ}`]['enabled']['units'] ||
                    !civsConfig[`${civ}`]['enabled']['units'].includes(name))) {
                      found = false;
                // if disabled -> bad
                } else if (civsConfig[`${civ}`]['disabled']['units']
                          && civsConfig[`${civ}`]['disabled']['units'].includes(name)
                          ) {
                            found = false;
                }
            } else if (type === "UNIQUEUNIT") {
              // Make sure this unique unit is specifically enabled for this civ
              // Sometimes "unique" units are also units e.g. genitour
              if (   (civsConfig[`${civ}`]['enabled']['unique']
                  && !civsConfig[`${civ}`]['enabled']['unique'].includes(name))

                  && (!civsConfig[`${civ}`]['enabled']['units'] ||
                  (civsConfig[`${civ}`]['enabled']['units']
                  && !civsConfig[`${civ}`]['enabled']['units'].includes(name)))) {
                    found = false;
                
              }
            } else if (type === "TECHNOLOGY") {
              // Make sure this technology isn't disabled for this civ.
              if (civsConfig[`${civ}`]['disabled']['techs']
                  && civsConfig[`${civ}`]['disabled']['techs'].includes(name)) {
                    found = false;
              }
            }
            else if (type === "BUILDING") {
              // Make sure this building isn't disabled for this civ
              // if not enabled and default is disabled -> bad
              if (defaultDisabledBuildings.includes(name) && 
                  (!civsConfig[`${civ}`]['enabled']['buildings'] ||
                  !civsConfig[`${civ}`]['enabled']['buildings'].includes(name))) {
                    found = false;
              // if disabled -> bad
              } else if (civsConfig[`${civ}`]['disabled']['buildings']
                        && civsConfig[`${civ}`]['disabled']['buildings'].includes(name)
                        ) {
                          found = false;
              }
            }
          }
          if (found) {
            xRefImage.style.opacity = '100%';
          } else {
            xRefImage.style.opacity = '20%';
          }
        }
    }

    function cost(cost_object) {
        let value = "";
        if ("Food" in cost_object) {
            value += " " + cost_object.Food + "F";
        }
        if ("Wood" in cost_object) {
            value += " " + cost_object.Wood + "W";
        }
        if ("Gold" in cost_object) {
            value += " " + cost_object.Gold + "G";
        }
        if ("Stone" in cost_object) {
            value += " " + cost_object.Stone + "S";
        }
        return value;
    }


</script>
</body>

</html>
